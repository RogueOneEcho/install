name: Build sox_ng
on:
  push:
  workflow_dispatch:
    inputs:
      sox_ng_version:
        required: true
        description: "sox_ng version (e.g., 14.7.0.9)"
      flac_version:
        required: true
        description: "FLAC version (e.g., 1.5.0)"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  SOX_NG_VERSION: "14.7.0.9"
  FLAC_VERSION: "1.5.0"

jobs:

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: ubuntu-24.04
          target: x86_64-unknown-linux-gnu
        - os: ubuntu-24.04-arm
          target: aarch64-unknown-linux-gnu
        - os: macos-15-intel
          target: x86_64-apple-darwin
        - os: macos-15
          target: aarch64-apple-darwin
    env:
      PREFIX: ${{ github.workspace }}/prefix
    steps:

    - uses: actions/checkout@v4

    - id: versions
      run: |
        echo "sox_ng=${{ inputs.sox_ng_version || env.SOX_NG_VERSION }}" >> "$GITHUB_OUTPUT"
        echo "flac=${{ inputs.flac_version || env.FLAC_VERSION }}" >> "$GITHUB_OUTPUT"

    - if: contains(matrix.os, 'ubuntu')
      run: sudo apt-get update && sudo apt-get install -y gcc make autoconf automake libtool libogg-dev libpng-dev libfftw3-dev

    - if: contains(matrix.os, 'macos')
      run: brew install autoconf automake libtool libogg libpng fftw

    - name: Build FLAC
      run: |
        FLAC_VERSION="${{ steps.versions.outputs.flac }}"
        JOBS="$(getconf _NPROCESSORS_ONLN)"
        curl -fSL "https://downloads.xiph.org/releases/flac/flac-${FLAC_VERSION}.tar.xz" | tar xJ
        cd "flac-${FLAC_VERSION}"
        ./configure \
          --prefix="$PREFIX" \
          --enable-static \
          --disable-shared \
          --disable-thorough-tests
        make -j"$JOBS"
        make install

    - name: Build sox_ng
      run: |
        SOX_NG_VERSION="${{ steps.versions.outputs.sox_ng }}"
        JOBS="$(getconf _NPROCESSORS_ONLN)"
        curl -fSL "https://codeberg.org/sox_ng/sox_ng/releases/download/sox_ng-${SOX_NG_VERSION}/sox_ng-${SOX_NG_VERSION}.tar.gz" | tar xz
        cd "sox_ng-${SOX_NG_VERSION}"
        PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig" \
        ./configure \
          --prefix="$PREFIX" \
          --enable-static \
          --disable-shared \
          --without-libltdl \
          --disable-openmp \
          --without-sndfile
        make -j"$JOBS"
        make install

    - run: '"$PREFIX/bin/flac" --version'

    - run: '"$PREFIX/bin/sox_ng" --version'

    - name: Package binaries
      run: |
        VERSION="${{ steps.versions.outputs.sox_ng }}"
        TARGET="${{ matrix.target }}"
        mkdir artifacts
        cp "$PREFIX"/bin/flac "$PREFIX"/bin/sox_ng artifacts/
        tar -cJf "artifacts/sox_ng-${VERSION}-${TARGET}.tar.xz" \
          -C artifacts flac sox_ng

    - uses: actions/upload-artifact@v4
      with:
        name: sox_ng-${{ steps.versions.outputs.sox_ng }}-${{ matrix.target }}
        path: artifacts/sox_ng-*.tar.xz


  github-release:
    runs-on: ubuntu-24.04
    if: inputs.sox_ng_version != ''
    needs: build
    steps:

    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        pattern: sox_ng-${{ inputs.sox_ng_version }}-*
        merge-multiple: true

    - name: gh release create
      env:
        GH_TOKEN: ${{ github.token }}
      run: >
        gh release create
        "sox_ng-${{ inputs.sox_ng_version }}"
        --title "sox_ng ${{ inputs.sox_ng_version }} (FLAC ${{ inputs.flac_version }})"
        --notes "Built sox_ng ${{ inputs.sox_ng_version }} against FLAC ${{ inputs.flac_version }}"
        --target ${{ github.ref_name }}

    - name: gh release upload
      env:
        GH_TOKEN: ${{ github.token }}
      run: >
        gh release upload
        "sox_ng-${{ inputs.sox_ng_version }}"
        sox_ng-${{ inputs.sox_ng_version }}-*
        --clobber
        --repo "${{ github.repository }}"
