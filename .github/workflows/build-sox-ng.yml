name: Build sox_ng
on:
  push:
  workflow_dispatch:
    inputs:
      sox_ng_version:
        required: true
        description: "sox_ng version (e.g., 14.7.0.9)"
      flac_version:
        required: true
        description: "FLAC version (e.g., 1.5.0)"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  SOX_NG_VERSION: "14.7.0.9"
  FLAC_VERSION: "1.5.0"

jobs:

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: ubuntu-24.04
          target: x86_64-unknown-linux-gnu
        - os: ubuntu-24.04
          target: x86_64-unknown-linux-musl
        - os: ubuntu-24.04-arm
          target: aarch64-unknown-linux-gnu
        - os: ubuntu-24.04-arm
          target: aarch64-unknown-linux-musl
        - os: macos-15-intel
          target: x86_64-apple-darwin
        - os: macos-15
          target: aarch64-apple-darwin
    steps:

    - uses: actions/checkout@v4

    - name: Resolve sox_ng version
      id: sox_ng
      run: |
        VERSION="${{ inputs.sox_ng_version || env.SOX_NG_VERSION }}"
        test -n "$VERSION"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: Resolve FLAC version
      id: flac
      run: |
        VERSION="${{ inputs.flac_version || env.FLAC_VERSION }}"
        test -n "$VERSION"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: Detect CPU count
      id: cpu
      run: |
        JOBS="$(getconf _NPROCESSORS_ONLN)"
        echo "jobs=$JOBS" >> "$GITHUB_OUTPUT"
        test "$JOBS" -gt 0

    - if: contains(matrix.os, 'ubuntu')
      run: sudo apt-get update && sudo apt-get install -y gcc make autoconf automake libtool libogg-dev libpng-dev libfftw3-dev

    - if: contains(matrix.target, 'musl')
      run: sudo apt-get install -y musl-tools

    - if: contains(matrix.os, 'macos')
      run: brew install autoconf automake libtool libogg libpng fftw

    - name: Download FLAC
      run: curl -fSL "https://downloads.xiph.org/releases/flac/flac-${{ steps.flac.outputs.version }}.tar.xz" | tar xJ

    - name: Configure FLAC
      if: contains(matrix.target, 'musl') == false
      working-directory: flac-${{ steps.flac.outputs.version }}
      run: >
        ./configure
        --prefix=${{ github.workspace }}/dist
        --enable-static
        --disable-shared
        --disable-thorough-tests

    - name: Configure FLAC (musl)
      if: contains(matrix.target, 'musl')
      working-directory: flac-${{ steps.flac.outputs.version }}
      run: >
        ./configure
        --prefix=${{ github.workspace }}/dist
        --enable-static
        --disable-shared
        --disable-thorough-tests
        CC=musl-gcc

    - name: Build FLAC
      working-directory: flac-${{ steps.flac.outputs.version }}
      run: make -j${{ steps.cpu.outputs.jobs }} && make install

    - name: Download sox_ng
      run: curl -fSL "https://codeberg.org/sox_ng/sox_ng/releases/download/sox_ng-${{ steps.sox_ng.outputs.version }}/sox_ng-${{ steps.sox_ng.outputs.version }}.tar.gz" | tar xz

    - name: Configure sox_ng
      if: contains(matrix.target, 'musl') == false
      working-directory: sox_ng-${{ steps.sox_ng.outputs.version }}
      run: >
        ./configure
        --prefix=${{ github.workspace }}/dist
        --enable-static
        --disable-shared
        --without-libltdl
        --disable-openmp
        --without-sndfile
      env:
        PKG_CONFIG_PATH: ${{ github.workspace }}/dist/lib/pkgconfig

    - name: Configure sox_ng (musl)
      if: contains(matrix.target, 'musl')
      working-directory: sox_ng-${{ steps.sox_ng.outputs.version }}
      run: >
        ./configure
        --prefix=${{ github.workspace }}/dist
        --enable-static
        --disable-shared
        --without-libltdl
        --disable-openmp
        --without-sndfile
        CC=musl-gcc
      env:
        PKG_CONFIG_PATH: ${{ github.workspace }}/dist/lib/pkgconfig

    - name: Build sox_ng
      working-directory: sox_ng-${{ steps.sox_ng.outputs.version }}
      run: make -j${{ steps.cpu.outputs.jobs }} && make install

    - run: ./dist/bin/flac --version

    - run: ./dist/bin/sox_ng --version

    - name: Package binaries
      run: >
        tar -cJf "sox_ng-${{ matrix.target }}.tar.xz"
        -C ./dist/bin flac sox_ng

    - uses: actions/upload-artifact@v4
      with:
        name: sox_ng-${{ matrix.target }}
        path: sox_ng-${{ matrix.target }}.tar.xz


  github-release:
    runs-on: ubuntu-24.04
    if: inputs.sox_ng_version != ''
    needs: build
    steps:

    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        pattern: sox_ng-*
        merge-multiple: true

    - name: gh release create
      env:
        GH_TOKEN: ${{ github.token }}
      run: >
        gh release create
        "sox_ng-${{ inputs.sox_ng_version }}-flac-${{ inputs.flac_version }}"
        --title "sox_ng ${{ inputs.sox_ng_version }} (FLAC ${{ inputs.flac_version }})"
        --notes "Built sox_ng ${{ inputs.sox_ng_version }} against FLAC ${{ inputs.flac_version }}"
        --target ${{ github.ref_name }}

    - name: gh release upload
      env:
        GH_TOKEN: ${{ github.token }}
      run: >
        gh release upload
        "sox_ng-${{ inputs.sox_ng_version }}-flac-${{ inputs.flac_version }}"
        sox_ng-*.tar.xz
        --clobber
        --repo "${{ github.repository }}"
